<div class="w-full overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="bg-zinc-50 dark:bg-slate-900/50 border-b border-gray-100 dark:border-slate-800 text-left">
                    <th
                        class="py-4 px-6 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider font-display rounded-tl-xl">
                        File Name</th>
                    <th
                        class="py-4 px-6 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider font-display">
                        Tags
                    </th>
                    <th
                        class="py-4 px-6 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider font-display">
                        Date
                    </th>
                    <th
                        class="py-4 px-6 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider font-display">
                        Owner</th>
                    <th
                        class="py-4 px-6 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider font-display text-right rounded-tr-xl">
                        Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50 dark:divide-slate-800">
                <!-- Folders -->
                <tr *ngFor="let folder of folders"
                    class="group hover:bg-zinc-50/50 dark:hover:bg-slate-800/50 transition-all duration-200 cursor-pointer"
                    [class.bg-blue-100]="selectedItem?.type === 'folder' && selectedItem?.id === folder._id"
                    draggable="true" (click)="selectItem('folder', folder._id)" (dblclick)="onFolderClick(folder._id)"
                    (dragstart)="onFolderDragStart($event, folder)" (dragover)="onFolderDragOver($event)"
                    (drop)="onFolderDrop($event, folder)">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-lg flex items-center justify-center bg-yellow-50 dark:bg-yellow-900/20 text-yellow-500 shadow-sm transition-transform group-hover:scale-105">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M19.7 7h-6.3c-.6 0-1.1-.4-1.3-.9l-.6-1.7c-.2-.6-.8-1-1.4-1h-5.9c-1.1 0-2 .9-2 2v12.2c0 1.1.9 2 2 2h15.5c1.1 0 2-.9 2-2v-8.6c0-1.1-.9-2-2-2z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <h3
                                    class="font-semibold text-black dark:text-white group-hover:text-zinc-700 dark:group-hover:text-zinc-300 transition-colors text-sm font-display mb-0.5">
                                    {{ folder.name }}
                                </h3>
                                <p class="text-xs text-zinc-400 font-sans">Folder</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4"></td>
                    <td class="px-6 py-4">
                        <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400 font-sans">{{ folder.updatedAt
                            |
                            date:'mediumDate' }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-6 h-6 rounded-full bg-gradient-to-r from-zinc-200 to-zinc-300 dark:from-slate-600 dark:to-slate-500 flex items-center justify-center text-[10px] font-bold text-zinc-700 dark:text-white shadow-sm border border-white dark:border-slate-700">
                                {{ (folder.owner?.name || 'U').charAt(0) }}
                            </div>
                            <span
                                class="text-sm text-zinc-600 dark:text-zinc-400 font-sans truncate max-w-[100px]">You</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div
                            class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <!-- Normal View: Delete Folder -->
                            <ng-container *ngIf="!isTrashView">
                                <button (click)="deleteItem(folder, 'folder'); $event.stopPropagation()"
                                    class="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all"
                                    title="Delete Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </ng-container>
                            <!-- Trash View: Restore + Permanent Delete -->
                            <ng-container *ngIf="isTrashView">
                                <button (click)="restoreFolder(folder); $event.stopPropagation()"
                                    class="p-2 text-zinc-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-all"
                                    title="Restore Folder">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6">
                                        </path>
                                    </svg>
                                </button>
                                <button (click)="permanentDeleteFolder(folder); $event.stopPropagation()"
                                    class="p-2 text-zinc-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all"
                                    title="Delete Permanently">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </ng-container>
                        </div>
                    </td>
                </tr>

                <!-- Documents -->
                <tr *ngFor="let doc of documents"
                    class="group hover:bg-zinc-50/50 dark:hover:bg-slate-800/50 transition-all duration-200"
                    (click)="selectedDocument = doc" draggable="true" (dragstart)="onDocDragStart($event, doc)">
                    <!-- File Name & Icon -->
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-sm transition-transform group-hover:scale-105"
                                [ngClass]="{
                                    'bg-red-50 dark:bg-red-900/20 text-red-500': doc.currentPath.endsWith('.pdf'),
                                    'bg-blue-50 dark:bg-blue-900/20 text-blue-500': !doc.currentPath.endsWith('.pdf')
                                }">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-black dark:text-white group-hover:text-zinc-700 dark:group-hover:text-zinc-300 transition-colors cursor-pointer text-sm font-display mb-0.5"
                                    (click)="openPreviewModal(doc)">
                                    {{ doc.title }}
                                </h3>
                                <p class="text-xs text-zinc-400 font-sans">v{{ doc.currentVersion }} â€¢ {{
                                    (doc.currentPath.split('.').pop() || 'file').toUpperCase() }}</p>
                            </div>
                        </div>
                    </td>

                    <!-- Tags -->
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-2">
                            <span *ngFor="let tag of doc.tags.slice(0, 3)"
                                class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-zinc-600 dark:text-zinc-300 shadow-sm">
                                #{{ tag }}
                            </span>
                            <span *ngIf="doc.tags.length > 3"
                                class="text-xs text-zinc-400 self-center">+{{doc.tags.length - 3}}</span>
                        </div>
                    </td>

                    <!-- Date -->
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400 font-sans">{{
                                doc.updatedAt |
                                date:'mediumDate' }}</span>
                            <span class="text-xs text-zinc-400 font-sans">{{ doc.updatedAt | date:'shortTime' }}</span>
                        </div>
                    </td>

                    <!-- Owner -->
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-6 h-6 rounded-full bg-gradient-to-r from-zinc-200 to-zinc-300 dark:from-slate-600 dark:to-slate-500 flex items-center justify-center text-[10px] font-bold text-zinc-700 dark:text-white shadow-sm border border-white dark:border-slate-700">
                                {{ (doc.owner.name || 'U').charAt(0) }}
                            </div>
                            <span class="text-sm text-zinc-600 dark:text-zinc-400 font-sans truncate max-w-[100px]">{{
                                isOwner(doc) ? 'You'
                                : doc.owner.name }}</span>
                        </div>
                    </td>

                    <!-- Actions -->
                    <td class="px-6 py-4 text-right">
                        <div
                            class="flex items-center justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                            <!-- Star -->
                            <button (click)="onToggleStar(doc)"
                                [class]="doc.isStarred ? 'text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/30' : 'text-zinc-400 hover:text-yellow-500 hover:bg-zinc-100 dark:hover:bg-slate-700'"
                                class="p-2 rounded-lg transition-all focus:outline-none" title="Star this document">
                                <svg class="w-4 h-4" [attr.fill]="doc.isStarred ? 'currentColor' : 'none'"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z">
                                    </path>
                                </svg>
                            </button>

                            <div class="h-4 w-px bg-zinc-200 dark:bg-slate-700 mx-1"></div>

                            <!-- Share -->
                            <button *ngIf="canEdit(doc)" (click)="openShareModal(doc)"
                                class="p-2 text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-slate-700 rounded-lg transition-all"
                                title="Share with User">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                                    </path>
                                </svg>
                            </button>

                            <!-- Public Link -->
                            <button *ngIf="isOwner(doc)" (click)="openPublicLinkModal(doc)"
                                class="p-2 text-zinc-500 dark:text-zinc-400 hover:bg-blue-100 dark:hover:bg-blue-900/20 hover:text-blue-600 rounded-lg transition-all"
                                title="Public Link">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                                    </path>
                                </svg>
                            </button>

                            <!-- Comments -->
                            <button (click)="openCommentsPanel(doc)"
                                class="p-2 text-zinc-500 dark:text-zinc-400 hover:bg-indigo-100 dark:hover:bg-indigo-900/20 hover:text-indigo-600 rounded-lg transition-all"
                                title="Comments">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                            </button>

                            <!-- Versions -->
                            <button (click)="openVersionModal(doc)"
                                class="p-2 text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-slate-700 rounded-lg transition-all"
                                title="Version History">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>

                            <!-- Download -->
                            <button (click)="downloadDocument(doc)"
                                class="p-2 text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-slate-700 rounded-lg transition-all"
                                title="Download">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>

                            <!-- Trash Actions (Restore & Permanent Delete) -->
                            <ng-container *ngIf="isTrashView">
                                <button (click)="restoreDocument(doc); $event.stopPropagation()"
                                    class="p-2 text-zinc-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-all"
                                    title="Restore">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                                <button (click)="permanentDeleteDocument(doc); $event.stopPropagation()"
                                    class="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all"
                                    title="Delete Forever">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </ng-container>

                            <!-- Normal Delete -->
                            <button *ngIf="!isTrashView && isOwner(doc)"
                                (click)="deleteItem(doc, 'document'); $event.stopPropagation()"
                                class="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all"
                                title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modals -->
<!-- Version History Modal - GitHub Style -->
<app-version-history *ngIf="showVersionModal" [document]="selectedDocument"
    [isOwner]="selectedDocument ? isOwner(selectedDocument) : false" (close)="closeVersionModal()"
    (refresh)="refresh.emit()">
</app-version-history>

<!-- Share Modal -->
<div *ngIf="showShareModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden border border-zinc-100">
        <div class="px-6 py-4 border-b border-gray-100 bg-zinc-50/50">
            <h3 class="font-bold text-lg text-black font-display">Share Document</h3>
        </div>

        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-zinc-700 mb-1">Email Address</label>
                    <input type="email" [(ngModel)]="shareEmail" placeholder="colleague@example.com"
                        class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-black focus:border-black outline-none transition-all placeholder:text-zinc-400" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-zinc-700 mb-1">Permission</label>
                    <select [(ngModel)]="sharePermission"
                        class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-black focus:border-black outline-none transition-all bg-white">
                        <option value="view">Can View</option>
                        <option value="edit">Can Edit</option>
                    </select>
                </div>

                <div class="flex items-center justify-end gap-3 mt-6">
                    <button (click)="closeShareModal()"
                        class="px-4 py-2 text-zinc-600 hover:bg-zinc-100 rounded-lg font-medium transition-colors">Cancel</button>
                    <button (click)="shareDocument()" [disabled]="sharing || !shareEmail"
                        class="px-6 py-2 bg-black text-white rounded-xl font-medium hover:bg-zinc-800 shadow-lg shadow-black/20 disabled:opacity-50 disabled:shadow-none transition-all">
                        {{ sharing ? 'Sharing...' : 'Share Access' }}
                    </button>
                </div>
                <p *ngIf="error" class="text-red-500 text-sm text-center">{{ error }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<app-preview-modal *ngIf="showPreviewModal" [document]="selectedDocument"
    (close)="closePreviewModal()"></app-preview-modal>

<!-- Public Link Modal -->
<app-public-link-modal *ngIf="showPublicLinkModal" [document]="selectedDocument"
    (close)="closePublicLinkModal()"></app-public-link-modal>

<!-- Comments Slide-in Panel -->
<div *ngIf="showCommentsPanel"
    class="fixed inset-y-0 right-0 w-96 bg-white dark:bg-slate-900 shadow-2xl z-50 transform transition-transform duration-300 border-l border-gray-200 dark:border-slate-700">
    <div class="absolute top-4 left-4">
        <button (click)="closeCommentsPanel()"
            class="p-2 hover:bg-zinc-100 dark:hover:bg-slate-800 rounded-lg transition-all">
            <svg class="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    <app-comments [documentId]="selectedDocument?._id || ''" [isVisible]="showCommentsPanel"></app-comments>
</div>
<div *ngIf="showCommentsPanel" (click)="closeCommentsPanel()" class="fixed inset-0 bg-black/30 z-40"></div>